import Dialog from './dialog';
import { useSelector, useDispatch } from "../../../EaseApp/index";
import React, { useState, useEffect } from 'react';
import i18next from "i18next";
import { Box, Checkbox, List, ListItem, InputBase, Button } from '@material-ui/core';
import { makeStyles } from '@material-ui/core/styles';
import Typography from '@material-ui/core/Typography';
import _ from 'lodash';
import rearch_icon from '../../../common/images/search@2x.png';
import deldete_icon from '../../../common/images/delete@2x.png';
import FormControlLabel from '@material-ui/core/FormControlLabel';
import WebIM from '../../../utils/WebIM';
import { message } from '../../common/alert';
var useStyles = makeStyles(function (theme) {
  return {
    root: {
      width: '650px',
      height: '480px'
    },
    listBox: {
      height: '410px',
      overflowY: 'auto'
    },
    container: {
      display: 'flex',
      minHeight: '410px'
    },
    btnBox: {
      height: '70px',
      lineHeight: '70px',
      textAlign: 'right',
      padding: '0 23px'
    },
    gMemberAvatar: {
      width: '36px',
      height: '36px',
      borderRadius: '20px',
      backgroundColor: '#FF9F4D'
    },
    searchBox: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      height: '30px'
    },
    contactsItem: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      height: '50px'
    },
    memberBox: {
      width: '50%',
      background: '#EDEFF2',
      padding: '10px'
    }
  };
});

var InviteModal = function InviteModal(props) {
  var _WebIM$conn, _WebIM$conn$context;

  var open = props.open,
      onClose = props.onClose,
      onCall = props.onCall,
      members = props.members,
      joinedMembers = props.joinedMembers;
  var classes = useStyles();
  var username = (_WebIM$conn = WebIM.conn) === null || _WebIM$conn === void 0 ? void 0 : (_WebIM$conn$context = _WebIM$conn.context) === null || _WebIM$conn$context === void 0 ? void 0 : _WebIM$conn$context.userId;
  var contacts = members.length > 0 ? members.map(function (item) {
    return {
      id: item.member || item.owner
    };
  }) : [];
  contacts = contacts.filter(function (item) {
    if (username == item.id) {
      return false;
    } else {
      return true;
    }
  });
  console.log('joinedMembers', joinedMembers);
  joinedMembers && joinedMembers.forEach(function (item) {
    var user = contacts.find(function (el) {
      if (el.id === item.imUserId) {
        return true;
      }
    });

    if (user) {
      user.checked = true;
      user.disabled = true;
    }
  });
  var groupById = useSelector(function (state) {
    var _state$group;

    return (_state$group = state.group) === null || _state$group === void 0 ? void 0 : _state$group.group.byId;
  }) || {};

  var _useState = useState(''),
      searchValue = _useState[0],
      setSearchValue = _useState[1];

  var _useState2 = useState([]),
      groupMembers = _useState2[0],
      setGroupMembers = _useState2[1];

  var _useState3 = useState(contacts),
      contactsObjs = _useState3[0],
      setContactsObjs = _useState3[1];

  console.log('contactsObjs', contactsObjs);
  useEffect(function () {
    setContactsObjs(contacts);
  }, [members]); // search value

  var searchChangeValue = function searchChangeValue(e) {
    setSearchValue(e.target.value);
  }; // click search


  var handleSearchValue = function handleSearchValue() {
    console.log(searchValue);

    if (searchValue === '') {
      contacts.forEach(function (user) {
        if (groupMembers.includes(user.id)) {
          user.checked = true;
        } else {
          user.checked = false;
        }
      });
      setContactsObjs(contacts);
      return;
    }

    var searched = contactsObjs.filter(function (item) {
      if (item.id.includes(searchValue)) {
        return item;
      }
    });
    setContactsObjs(searched);
  };

  var handleSelect = function handleSelect(val) {
    return function (e) {
      console.log('e.target.checked', e.target);

      if (e.target.checked) {
        var joinedNum = joinedMembers ? joinedMembers.length : 0;

        if (joinedNum > 0 && groupMembers.length + joinedNum >= 3) {
          message.error('There can only be 16 people in the channel');
          return;
        }

        if (joinedNum === 0 && groupMembers.length + 1 >= 3) {
          message.error('There can only be 16 people in the channel');
          return;
        }

        var newSelected = [].concat(groupMembers);
        newSelected.push(val);
        console.log('groupMembers', [].concat(newSelected));
        setGroupMembers(newSelected);
        var newContactsObjs = [].concat(contactsObjs);
        newContactsObjs.forEach(function (value) {
          if (value.id === val) {
            value.checked = true;
          }
        });
        setContactsObjs(newContactsObjs);
      } else if (!e.target.checked) {
        var _newSelected = [].concat(groupMembers);

        var groupMembersPull = _.pull(_newSelected, val);

        setGroupMembers(groupMembersPull);

        var _newContactsObjs = [].concat(contactsObjs);

        _newContactsObjs.forEach(function (value) {
          if (value.id === val) {
            value.checked = false;
          }
        });

        setContactsObjs(_newContactsObjs);
      }
    };
  };

  var deleteGroupMember = function deleteGroupMember(val) {
    return function () {
      var newGroupAry = _.pull(groupMembers, val);

      setGroupMembers(newGroupAry);
      contactsObjs.forEach(function (value) {
        if (value.id === val) {
          value.checked = false;
        }
      });
      setContactsObjs([].concat(contactsObjs));
    };
  };

  var startCall = function startCall() {
    onCall(groupMembers);
    setGroupMembers([]);
    setContactsObjs([]);
    setSearchValue([]);
  };

  var onCloseModal = function onCloseModal() {
    setGroupMembers([]);
    setContactsObjs([]);
    setSearchValue([]);
    onClose();
  };

  var renderMember = function renderMember() {
    return /*#__PURE__*/React.createElement(Box, {
      className: classes.root
    }, /*#__PURE__*/React.createElement(Box, {
      className: classes.listBox
    }, /*#__PURE__*/React.createElement(Box, {
      className: classes.container
    }, /*#__PURE__*/React.createElement(Box, {
      style: {
        width: '50%',
        background: '#F5F7FA',
        padding: '10px'
      }
    }, /*#__PURE__*/React.createElement(Box, {
      className: classes.searchBox
    }, /*#__PURE__*/React.createElement(InputBase, {
      type: "search",
      placeholder: i18next.t('Group Members'),
      style: {
        width: '100%',
        padding: '5px'
      },
      onChange: searchChangeValue
    }), /*#__PURE__*/React.createElement("img", {
      src: rearch_icon,
      alt: "",
      style: {
        width: '32px',
        cursor: 'pointer'
      },
      onClick: handleSearchValue
    })), /*#__PURE__*/React.createElement(List, null, contactsObjs.length > 0 && contactsObjs.map(function (item, key) {
      return /*#__PURE__*/React.createElement(ListItem, {
        key: key,
        onClick: handleSelect(item.id),
        className: classes.contactsItem
      }, /*#__PURE__*/React.createElement(Box, {
        style: {
          display: 'flex',
          alignItems: 'center'
        }
      }, /*#__PURE__*/React.createElement(Box, {
        className: classes.gMemberAvatar
      }), /*#__PURE__*/React.createElement(Typography, {
        style: {
          marginLeft: '10px'
        }
      }, item.id)), /*#__PURE__*/React.createElement(FormControlLabel, {
        disabled: item.disabled,
        control: /*#__PURE__*/React.createElement(Checkbox, {
          checked: !!item.checked
        })
      }));
    }))), /*#__PURE__*/React.createElement(Box, {
      className: classes.memberBox
    }, /*#__PURE__*/React.createElement(Typography, null, i18next.t('Selected') + "(" + groupMembers.length + ")"), /*#__PURE__*/React.createElement(List, null, groupMembers.length > 0 && groupMembers.map(function (item, key) {
      return /*#__PURE__*/React.createElement(ListItem, {
        key: key,
        className: classes.contactsItem
      }, /*#__PURE__*/React.createElement(Box, {
        style: {
          display: 'flex',
          alignItems: 'center'
        }
      }, /*#__PURE__*/React.createElement(Box, {
        className: classes.gMemberAvatar
      }), /*#__PURE__*/React.createElement(Typography, {
        style: {
          marginLeft: '10px'
        }
      }, item)), /*#__PURE__*/React.createElement("img", {
        src: deldete_icon,
        alt: "",
        style: {
          width: '20px',
          cursor: 'pointer'
        },
        onClick: deleteGroupMember(item)
      }));
    }))))), /*#__PURE__*/React.createElement(Box, {
      className: classes.btnBox
    }, /*#__PURE__*/React.createElement(Button, {
      style: {
        textTransform: "none"
      },
      variant: "contained",
      color: "primary",
      onClick: startCall,
      disabled: groupMembers.length == 0
    }, "Call")));
  };

  return /*#__PURE__*/React.createElement(Dialog, {
    open: !!open,
    onClose: onCloseModal,
    title: i18next.t('Call for Gromp Members'),
    content: renderMember(),
    maxWidth: 880
  });
};

export default InviteModal;