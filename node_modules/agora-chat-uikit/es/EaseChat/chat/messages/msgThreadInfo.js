import React, { useContext } from "react";
import { makeStyles } from "@material-ui/styles";
import { Box } from "@material-ui/core";
import threadIcon from '../../../common/images/thread.png';
import openIcon from '../../../common/images/open.png';
import { useSelector, useDispatch } from "../../../EaseApp/index";
import ThreadActions from "../../../redux/thread";
import MessageActions from "../../../redux/message";
import { getTimeDiff } from "../../../utils/index";
import WebIM from "../../../utils/WebIM";
import avatar from "../../../common/icons/avatar1.jpg";
import i18next from "i18next";
import { emoji } from "../../../common/emoji";
import AppDB from "../../../utils/AppDB";
import { message as Alert } from '../../../EaseChat/common/alert';
import { EaseChatContext } from "../index";
import { userAvatar } from '../../../utils';
var useStyles = makeStyles(function (theme) {
  var _container;

  return {
    root: {
      position: 'relative',
      minWidth: "134px",
      marginTop: "5px",
      width: '100%',
      height: "85px",
      display: "flex"
    },
    container: (_container = {
      position: 'absolute',
      bottom: '0',
      display: 'flex',
      flexDirection: 'column',
      marginTop: '8px',
      padding: '0px 10px',
      width: '100%',
      height: "80px"
    }, _container["display"] = "flex", _container.background = '#fff', _container.borderRadius = '5px', _container.boxSizing = 'border-box', _container),
    triangle: {
      display: 'block',
      position: 'absolute',
      left: '13px',
      top: '-8px',
      height: '0',
      width: '0',
      borderLeft: '8px solid transparent',
      borderRight: '8px solid transparent',
      borderBottom: '8px solid #fff'
    },
    threadTop: {
      display: 'flex',
      marginTop: '4px',
      height: '20px',
      lineHeight: '20px',
      width: '100%'
    },
    threadIcon: {
      flex: '0 0 20px',
      marginTop: '3px',
      height: '13px',
      background: "url(" + threadIcon + ") 2px center no-repeat",
      backgroundSize: 'contain'
    },
    threadName: {
      flex: '1 1 auto',
      fontWeight: '700',
      fontSize: '14px',
      overflow: 'hidden',
      textOverflow: 'ellipsis',
      whiteSpace: 'nowrap',
      color: '#000',
      textAlign: 'left'
    },
    messageCount: {
      flex: '0 0 42px',
      textAlign: 'right',
      fontWeight: '500',
      color: '#154DFE'
    },
    threadBottom: {
      marginTop: '9px',
      width: '100%',
      height: '35px',
      overflow: 'hidden',
      textAlign: 'left'
    },
    threadInfo: {
      display: 'flex',
      height: '16px',
      lineHeight: '16px',
      width: '100%'
    },
    messageInfo: {
      marginTop: '3px',
      display: 'inline-block',
      paddingLeft: '20px',
      height: '16px',
      lineHeight: '16px',
      color: '#4d4d4d',
      fontSize: '12px',
      overflow: 'hidden',
      textOverflow: 'ellipsis',
      whiteSpace: 'nowrap',
      width: '100%',
      boxSizing: 'border-box'
    },
    threadAva: {
      flex: '0 0 16px',
      textAlign: 'center',
      lineHeight: '16px'
    },
    threadAvaIcon: {
      display: 'inline-block',
      marginTop: '2px',
      height: '14px',
      width: '14px',
      borderRadius: '50%'
    },
    threadMsg: {
      marginLeft: '4px',
      fontSize: '14px',
      overflow: 'hidden',
      textOverflow: 'ellipsis',
      whiteSpace: 'nowrap',
      color: '#000',
      width: 'calc(100% - 70px)',
      fontWeight: '500'
    },
    time: {
      color: '#999',
      fontSize: '12px',
      flex: '0 0 50px',
      textAlign: 'right'
    },
    threadOwner: {
      color: '#000'
    },
    lastMessage: {
      color: '#666'
    },
    defaultMessage: {
      fontSize: '12px',
      lineHeight: '16px',
      marginTop: '8px',
      color: '#4d4d4d',
      textAlign: 'left'
    },
    count: {
      marginRight: '4px'
    },
    openImg: {
      width: '8px',
      height: '12px',
      objectFit: 'contain'
    }
  };
});

var MsgThreadInfo = function MsgThreadInfo(props) {
  var chatThreadOverview = props.message.chatThreadOverview;
  var easeChatProps = useContext(EaseChatContext);
  var onOpenThreadPanel = easeChatProps.onOpenThreadPanel;
  var dispatch = useDispatch();
  var classes = useStyles();

  var renderMessage = function renderMessage(message) {
    switch (message.type) {
      case 'txt':
        return renderTxt(message.msg);

      case 'file':
        return "[" + i18next.t('File') + "]";

      case 'img':
        return "[" + i18next.t('Image') + "]";

      case 'audio':
        return "[" + i18next.t('Audio') + "]";

      case 'video':
        return "[" + i18next.t('Video') + "]";

      default:
        return '';
    }
  };

  var renderTxt = function renderTxt(txt) {
    if (txt === undefined) {
      return [];
    }

    var rnTxt = [];
    var match = null;
    var regex = /(\[.*?\])/g;
    var start = 0;
    var index = 0;

    while (match = regex.exec(txt)) {
      index = match.index;

      if (index > start) {
        rnTxt.push(txt.substring(start, index));
      }

      if (match[1] in emoji.map) {
        var v = emoji.map[match[1]];
        rnTxt.push( /*#__PURE__*/React.createElement("img", {
          key: v + Math.floor(Math.random() * 99 + 1),
          alt: v,
          src: require("../../../common/reactions/" + v)["default"],
          width: 20,
          height: 20,
          style: {
            verticalAlign: 'middle'
          }
        }));
      } else {
        rnTxt.push(match[1]);
      }

      start = index + match[1].length;
    }

    rnTxt.push(txt.substring(start, txt.length));
    return rnTxt;
  };

  var threadList = useSelector(function (state) {
    var _state$thread;

    return (_state$thread = state.thread) === null || _state$thread === void 0 ? void 0 : _state$thread.threadList;
  }) || [];

  var changeMessage = function changeMessage() {
    //Whether you are in the thread. If not, call the interface added by SDK
    var hasJoined = threadList.find(function (item) {
      return item.id === props.message.chatThreadOverview.id;
    });

    if (!hasJoined) {
      WebIM.conn.joinChatThread({
        chatThreadId: props.message.chatThreadOverview.id
      }).then(function (res) {
        changeThreadStatus();
      })["catch"](function (e) {
        if (e.type === 1301) {
          changeThreadStatus();
        } else if (e.type === 1300) {
          Alert.warn(i18next.t('The thread has been disbanded'));
        }
      });
      return;
    }

    changeThreadStatus();
  }; //changes thread status after joing the thread


  var changeThreadStatus = function changeThreadStatus() {
    //change the status of creatingThread
    dispatch(ThreadActions.setIsCreatingThread(false)); //updtate currentThreadInfo

    WebIM.conn.getChatThreadDetail({
      chatThreadId: props.message.chatThreadOverview.id
    }).then(function (res) {
      var _res$data;

      dispatch(ThreadActions.setCurrentThreadInfo(res.data)); //updatea setThreadOriginalMsg

      if ((_res$data = res.data) === null || _res$data === void 0 ? void 0 : _res$data.messageId) {
        AppDB.findLocalMessage('groupChat', res.data.messageId).then(function (res) {
          var msg = res.length === 1 ? res[0] : {};
          dispatch(ThreadActions.setThreadOriginalMsg(msg));
        });
      }

      onOpenThreadPanel && onOpenThreadPanel(res.data);
    }); //open threadPanel

    dispatch(ThreadActions.updateThreadStates(true));
  };

  return /*#__PURE__*/React.createElement(Box, {
    className: classes.root
  }, /*#__PURE__*/React.createElement("div", {
    className: classes.container,
    onClick: changeMessage
  }, /*#__PURE__*/React.createElement("span", {
    className: classes.triangle
  }), /*#__PURE__*/React.createElement("div", {
    className: classes.threadTop
  }, /*#__PURE__*/React.createElement("div", {
    className: classes.threadIcon
  }), /*#__PURE__*/React.createElement("div", {
    className: classes.threadName
  }, chatThreadOverview.name), /*#__PURE__*/React.createElement("div", {
    className: classes.messageCount
  }, /*#__PURE__*/React.createElement("span", {
    className: classes.count
  }, chatThreadOverview.messageCount > 99 ? '99+' : chatThreadOverview.messageCount), /*#__PURE__*/React.createElement("img", {
    alt: "",
    className: classes.openImg,
    src: openIcon
  }))), chatThreadOverview.lastMessage && JSON.stringify(chatThreadOverview.lastMessage) !== '{}' && /*#__PURE__*/React.createElement("div", {
    className: classes.threadBottom
  }, /*#__PURE__*/React.createElement("div", {
    className: classes.threadInfo
  }, /*#__PURE__*/React.createElement("div", {
    className: classes.threadAva
  }, /*#__PURE__*/React.createElement("img", {
    className: classes.threadAvaIcon,
    src: userAvatar(chatThreadOverview.lastMessage.from)
  })), /*#__PURE__*/React.createElement("span", {
    className: classes.threadMsg
  }, chatThreadOverview.lastMessage.from || ''), /*#__PURE__*/React.createElement("span", {
    className: classes.time
  }, getTimeDiff(chatThreadOverview.lastMessage.time))), /*#__PURE__*/React.createElement("span", {
    className: classes.messageInfo
  }, renderMessage(chatThreadOverview.lastMessage))), (!chatThreadOverview.lastMessage || JSON.stringify(chatThreadOverview.lastMessage) === '{}') && /*#__PURE__*/React.createElement("div", {
    className: classes.defaultMessage
  }, "No Messages")));
};

export default MsgThreadInfo;