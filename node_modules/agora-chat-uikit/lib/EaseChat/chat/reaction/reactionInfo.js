"use strict";

exports.__esModule = true;
exports["default"] = void 0;

var _react = _interopRequireWildcard(require("react"));

var _rnReactionEmoji = _interopRequireDefault(require("../../../utils/rnReactionEmoji"));

var _styles = require("@material-ui/styles");

var _index = _interopRequireDefault(require("../../../redux/index"));

var _message = _interopRequireDefault(require("../../../redux/message"));

var _WebIM = _interopRequireDefault(require("../../../utils/WebIM"));

var _Dialog = _interopRequireDefault(require("@material-ui/core/Dialog"));

var _AppBar = _interopRequireDefault(require("@material-ui/core/AppBar"));

var _Tabs = _interopRequireDefault(require("@material-ui/core/Tabs"));

var _Tab = _interopRequireDefault(require("@material-ui/core/Tab"));

var _Typography = _interopRequireDefault(require("@material-ui/core/Typography"));

var _Box = _interopRequireDefault(require("@material-ui/core/Box"));

var _Avatar = _interopRequireDefault(require("@material-ui/core/Avatar"));

var _reaction_delete2x = _interopRequireDefault(require("../../../common/icons/reaction_delete@2x.png"));

var _avatar = _interopRequireDefault(require("../../../common/images/avatar1.jpg"));

var _avatar2 = _interopRequireDefault(require("../../../common/images/avatar2.jpg"));

var _avatar3 = _interopRequireDefault(require("../../../common/images/avatar3.jpg"));

var _threadClose = _interopRequireDefault(require("../../../common/images/threadClose.png"));

var _excluded = ["children", "value", "index"];

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { "default": obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj["default"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }

function _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }

var useStyles = (0, _styles.makeStyles)(function (theme) {
  return {
    infoBox: {
      height: "360px",
      width: "480px",
      flexGrow: 1
    },
    infoTitle: {
      display: "flex",
      alignItems: "center",
      justifyContent: "space-between",
      padding: "0px 15px",
      height: "58px",
      borderBottom: "1px solid #C4C4C4"
    },
    infoReaction: {
      height: "calc(100% - 60px)"
    },
    textStyleTitle: {
      fontFamily: "Roboto",
      fontWeight: "600",
      fontStyle: "normal",
      fontSize: "18px",
      LineHeight: "28px",
      blend: "Pass through",
      padding: "8px"
    },
    closeStyle: {
      width: "14px",
      height: "14px",
      blend: "Pass through",
      cursor: "pointer"
    },
    root: {
      background: "#FFFFFF",
      '& .MuiTabs-scroller .MuiTabs-indicator': {
        background: '#114EFF',
        height: '3px',
        display: 'inline-block',
        borderRadius: '5px'
      },
      '& .MuiTabScrollButton-root': {
        width: '25px',
        '& .MuiSvgIcon-root': {
          width: '25px',
          height: '25px'
        }
      }
    },
    iconStyle: {
      width: "24px",
      height: "24px",
      cursor: "pointer"
    },
    reactionItem: {
      width: "70px !important",
      minWidth: "0 !important"
    },
    tabPanelItem: {
      position: "relative",
      '& .MuiBox-root': {
        padding: '12px'
      }
    },
    reactionNumLabel: {
      display: "flex",
      justifyContent: "center",
      "& span": {
        margin: "0 10px"
      }
    },
    reactionUsreItem: {
      display: "flex",
      justifyContent: "space-between",
      alignItems: "center"
    },
    reactionUserStyle: {
      display: "flex",
      justifyContent: "space-between",
      alignItems: "center",
      fontFamily: "SF Compact Text",
      fontWeight: "600",
      fontStyle: "normal",
      fontSize: "16px",
      lineHeight: "20px",
      marginTop: "10px"
    },
    userBox: {
      display: "flex",
      justifyContent: "center",
      alignItems: "center"
    },
    textStyle: {
      marginLeft: '8px !important'
    },
    myselfPopover: {
      '& .MuiDialog-paper': {
        borderRadius: '12px' // backdropFilter: 'blur(12px)',
        // background: 'rgba(255,255,255,.8)',

      }
    }
  };
});

function TabPanel(props) {
  var children = props.children,
      value = props.value,
      index = props.index,
      other = _objectWithoutPropertiesLoose(props, _excluded);

  return /*#__PURE__*/_react["default"].createElement("div", _extends({
    role: "tabpanel",
    hidden: value !== index,
    id: "scrollable-force-tabpanel-" + index,
    "aria-labelledby": "scrollable-force-tab-" + index
  }, other), value === index && /*#__PURE__*/_react["default"].createElement(_Box["default"], {
    p: 3
  }, /*#__PURE__*/_react["default"].createElement(_Typography["default"], null, children)));
}

function a11yProps(index) {
  return {
    id: "scrollable-force-tab-" + index,
    "aria-controls": "scrollable-force-tabpanel-" + index
  };
}

var ReactionInfo = function ReactionInfo(_ref) {
  var anchorEl = _ref.anchorEl,
      onClose = _ref.onClose,
      message = _ref.message;
  var classes = useStyles();

  var _useState = (0, _react.useState)(0),
      value = _useState[0],
      setValue = _useState[1];

  var reactionMsg = message.reactions || [];
  var loginUserId = _WebIM["default"].conn.context.userId || "";
  var userAvatars = {
    1: _avatar["default"],
    2: _avatar2["default"],
    3: _avatar3["default"]
  };
  (0, _react.useEffect)(function () {
    setValue(0);
  }, [anchorEl]);

  var handleChange = function handleChange(event, newValue) {
    setValue(newValue);
  };

  var handleDeleteReaction = function handleDeleteReaction(reaction) {
    if (reactionMsg.length === 0) {
      onClose();
    }

    _index["default"].dispatch(_message["default"].deleteReaction(message, reaction));
  };

  var reactionUserList = function reactionUserList(item) {
    var userList = item.userList,
        reaction = item.reaction;
    var userName = "";
    return /*#__PURE__*/_react["default"].createElement(_react["default"].Fragment, null, userList.map(function (val, i) {
      var isCurrentLoginUser = val === loginUserId;

      if (isCurrentLoginUser) {
        userName = "You";
      } else {
        userName = val;
      }

      return /*#__PURE__*/_react["default"].createElement("div", {
        key: i,
        className: classes.reactionUserStyle
      }, /*#__PURE__*/_react["default"].createElement("div", {
        className: classes.userBox
      }, /*#__PURE__*/_react["default"].createElement(_Avatar["default"], {
        src: userAvatars[1]
      }), /*#__PURE__*/_react["default"].createElement(_Typography["default"], {
        className: classes.textStyle
      }, userName)), isCurrentLoginUser && /*#__PURE__*/_react["default"].createElement("img", {
        src: _reaction_delete2x["default"],
        alt: "",
        className: classes.iconStyle,
        onClick: function onClick() {
          return handleDeleteReaction(reaction);
        }
      }));
    }));
  };

  return /*#__PURE__*/_react["default"].createElement(_Dialog["default"], {
    open: anchorEl,
    onClose: onClose,
    className: classes.myselfPopover
  }, /*#__PURE__*/_react["default"].createElement(_Box["default"], {
    className: classes.infoBox
  }, /*#__PURE__*/_react["default"].createElement(_Box["default"], {
    className: classes.infoTitle
  }, /*#__PURE__*/_react["default"].createElement("span", {
    className: classes.textStyleTitle
  }, "Reactions"), /*#__PURE__*/_react["default"].createElement("span", {
    className: classes.closeStyle,
    onClick: onClose
  }, /*#__PURE__*/_react["default"].createElement("img", {
    slt: "",
    src: _threadClose["default"]
  }))), /*#__PURE__*/_react["default"].createElement(_Box["default"], {
    className: classes.infoReaction
  }, /*#__PURE__*/_react["default"].createElement(_AppBar["default"], {
    position: "static",
    color: "default",
    style: {
      boxShadow: "none"
    }
  }, /*#__PURE__*/_react["default"].createElement(_Tabs["default"], {
    value: value,
    onChange: handleChange,
    variant: "scrollable",
    scrollButtons: "on",
    indicatorColor: "primary",
    textColor: "primary",
    "aria-label": "scrollable force tabs example",
    className: classes.root
  }, reactionMsg.map(function (item, i) {
    if (item.count === 0) return;

    var label = /*#__PURE__*/_react["default"].createElement("div", {
      className: classes.reactionNumLabel
    }, (0, _rnReactionEmoji["default"])(item.reaction), " ", /*#__PURE__*/_react["default"].createElement("span", null, item.userList.length));

    return /*#__PURE__*/_react["default"].createElement(_Tab["default"], _extends({
      label: label
    }, a11yProps(i), {
      className: classes.reactionItem,
      key: i
    }));
  }))), reactionMsg.map(function (item, i) {
    if (item.count === 0) return;
    return /*#__PURE__*/_react["default"].createElement("div", {
      key: item.reaction
    }, /*#__PURE__*/_react["default"].createElement(TabPanel, {
      value: value,
      index: i,
      className: classes.tabPanelItem
    }, /*#__PURE__*/_react["default"].createElement("div", null, reactionUserList(item))));
  }))));
};

var _default = (0, _react.memo)(ReactionInfo);

exports["default"] = _default;
module.exports = exports.default;