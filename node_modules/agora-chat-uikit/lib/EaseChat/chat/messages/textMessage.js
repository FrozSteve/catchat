"use strict";

exports.__esModule = true;
exports["default"] = void 0;

var _react = _interopRequireWildcard(require("react"));

var _styles = require("@material-ui/styles");

var _i18next = _interopRequireDefault(require("i18next"));

var _core = require("@material-ui/core");

var _avatar = _interopRequireDefault(require("../../../common/icons/avatar1.jpg"));

var _emoji = require("../../../common/emoji");

var _utils = require("../../../utils");

var _messageStatus = _interopRequireDefault(require("./messageStatus"));

var _msgThreadInfo = _interopRequireDefault(require("./msgThreadInfo"));

var _reactCopyToClipboard = require("react-copy-to-clipboard");

var _reaction = _interopRequireDefault(require("../reaction"));

var _renderReaction = _interopRequireDefault(require("../reaction/renderReaction"));

var _index = require("../index");

var _thread = _interopRequireDefault(require("../../../common/images/thread.png"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { "default": obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj["default"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

var useStyles = (0, _styles.makeStyles)(function (theme) {
  var _textBody;

  return {
    pulldownListItem: {
      display: "flex",
      padding: "10px 0",
      listStyle: "none",
      marginTop: "26px",
      position: "relative",
      flexDirection: function flexDirection(props) {
        return props.bySelf ? "row-reverse" : "row";
      },
      alignItems: "flex-end"
    },
    userName: {
      padding: "0 10px 4px",
      color: "#8797A4",
      fontSize: "14px",
      display: function display(props) {
        return props.chatType !== "singleChat" && !props.bySelf ? "inline-block" : "none";
      },
      textAlign: function textAlign(props) {
        return props.bySelf ? "right" : "left";
      }
    },
    textBodyBox: {
      display: "flex",
      flexDirection: function flexDirection(props) {
        return props.bySelf ? "inherit" : "column";
      },
      maxWidth: "75%",
      alignItems: function alignItems(props) {
        return props.bySelf ? "inherit" : "unset";
      }
    },
    time: {
      position: "absolute",
      fontSize: "11px",
      height: "16px",
      color: "rgba(1, 1, 1, .2)",
      lineHeight: "20px",
      textAlign: "center",
      top: "-18px",
      width: "100%"
    },
    read: {
      fontSize: "10px",
      color: "rgba(0,0,0,.15)",
      margin: "3px"
    },
    avatarStyle: {
      height: "28px",
      width: "28px",
      borderRadius: "50%"
    },
    textBody: (_textBody = {
      margin: function margin(props) {
        return props.bySelf ? "0 0px 10px 0" : props.rnReactions ? "15px 0 10px 10px" : "0 0 10px 10px";
      },
      lineHeight: "22px",
      fontSize: "16px",
      background: function background(props) {
        return props.bySelf ? "linear-gradient(135deg, #B128DD 0%, #234AFC 100%)" : "#F2F2F2";
      },
      color: function color(props) {
        return props.bySelf ? "#fff" : "#000";
      },
      borderRadius: function borderRadius(props) {
        return props.bySelf ? "16px 16px 4px 16px" : "16px 16px 16px 4px";
      },
      padding: "8px 12px",
      width: "100%",
      maxWidth: "100%",
      // maxWidth: "80%",
      // minWidth: "40%",
      wordBreak: "break-all",
      textAlign: "initial",
      position: "relative",
      boxSizing: "border-box"
    }, _textBody["wordBreak"] = 'break-word', _textBody.fontFamily = 'Roboto', _textBody),
    textReaction: {
      position: "absolute",
      right: function right(props) {
        return props.bySelf ? "" : "-6px";
      },
      bottom: "2px",
      transform: function transform(props) {
        return props.bySelf ? "translateX(-100%)" : "translateX(100%)";
      },
      marginLeft: function marginLeft(props) {
        return props.bySelf ? "-10px" : "";
      },
      height: '24px',
      left: function left(props) {
        return props.bySelf ? "8px" : "";
      }
    },
    textReactionCon: {
      height: '100%',
      width: function width(props) {
        return props.showThreadEntry ? "48px" : "24px";
      },
      "float": function float(props) {
        return props.bySelf ? 'right' : 'left';
      }
    },
    reactionBox: {
      position: "absolute",
      top: function top(props) {
        return props.bySelf ? "-28px" : "-18px";
      },
      right: function right(props) {
        return props.bySelf ? "0px" : "";
      },
      left: function left(props) {
        return props.bySelf ? "" : "0px";
      },
      background: "#F2F2F2",
      borderRadius: "17.5px",
      padding: function padding(props) {
        return props.rnReactions ? "4px 8px" : "4px";
      },
      border: "solid 2px #FFFFFF" // boxShadow: "0 10px 10px 0 rgb(0 0 0 / 30%)",

    },
    threadCon: {
      "float": function float(props) {
        return props.bySelf ? 'left' : 'right';
      },
      height: '24px',
      width: '24px',
      borderRadius: '50%',
      '&:hover': {
        background: '#E6E6E6'
      }
    },
    thread: {
      marginTop: '5px',
      marginLeft: '4px',
      width: '16px',
      height: '15px',
      background: "url(" + _thread["default"] + ") center center no-repeat",
      backgroundSize: 'contain',
      cursor: 'pointer'
    },
    tooltipthread: {
      background: '#fff',
      color: 'rgba(0, 0, 0, 0.87)',
      boxShadow: '6px 6px 12px rgba(0, 0, 0, 0.12), -2px 0px 8px rgba(0, 0, 0, 0.08)'
    }
  };
});
var initialState = {
  mouseX: null,
  mouseY: null
};

function TextMessage(_ref) {
  var message = _ref.message,
      onRecallMessage = _ref.onRecallMessage,
      showByselfAvatar = _ref.showByselfAvatar,
      onCreateThread = _ref.onCreateThread,
      isThreadPanel = _ref.isThreadPanel,
      showThread = _ref.showThread;
  var easeChatProps = (0, _react.useContext)(_index.EaseChatContext);
  var onAvatarChange = easeChatProps.onAvatarChange,
      isShowReaction = easeChatProps.isShowReaction,
      customMessageClick = easeChatProps.customMessageClick,
      customMessageList = easeChatProps.customMessageList;

  var _useState = (0, _react.useState)(false),
      hoverDeviceModule = _useState[0],
      setHoverDeviceModule = _useState[1];

  var reactionMsg = (message === null || message === void 0 ? void 0 : message.reactions) || [];
  var showThreadEntry = showThread && !message.chatThreadOverview && !isThreadPanel && message.chatType === 'groupChat';
  var showThreaddInfo = showThread && !isThreadPanel && message.chatType === "groupChat" && message.chatThreadOverview && JSON.stringify(message.chatThreadOverview) !== '{}';
  var classes = useStyles({
    bySelf: message.bySelf,
    chatType: message.chatType,
    rnReactions: reactionMsg.length > 0,
    showThreadEntry: showThreadEntry
  });

  var _useState2 = (0, _react.useState)(initialState),
      menuState = _useState2[0],
      setMenuState = _useState2[1];

  var _useState3 = (0, _react.useState)(''),
      copyMsgVal = _useState3[0],
      setCopyMsgVal = _useState3[1];

  (0, _react.useEffect)(function () {
    setCopyMsgVal(message.msg);
  }, [copyMsgVal]);

  var handleClick = function handleClick(event) {
    event.preventDefault();
    setMenuState({
      mouseX: event.clientX - 2,
      mouseY: event.clientY - 4
    });
  };

  var handleClose = function handleClose() {
    setMenuState(initialState);
  };

  var recallMessage = function recallMessage() {
    onRecallMessage(message);
    handleClose();
  };

  var renderTxt = function renderTxt(txt) {
    if (txt === undefined) {
      return [];
    }

    var rnTxt = [];
    var match = null;
    var regex = /(\[.*?\])/g;
    var start = 0;
    var index = 0;

    while (match = regex.exec(txt)) {
      index = match.index;

      if (index > start) {
        rnTxt.push(txt.substring(start, index));
      }

      if (match[1] in _emoji.emoji.map) {
        var v = _emoji.emoji.map[match[1]];
        rnTxt.push( /*#__PURE__*/_react["default"].createElement("img", {
          key: v + Math.floor(Math.random() * 100000 + 1) + new Date().getTime().toString(),
          alt: v,
          src: require("../../../common/reactions/" + v)["default"],
          width: 20,
          height: 20,
          style: {
            verticalAlign: 'middle'
          }
        }));
      } else {
        rnTxt.push(match[1]);
      }

      start = index + match[1].length;
    }

    rnTxt.push(txt.substring(start, txt.length));
    return rnTxt;
  };

  var sentStatus = function sentStatus() {
    return /*#__PURE__*/_react["default"].createElement("div", null, message.bySelf && !isThreadPanel && /*#__PURE__*/_react["default"].createElement(_messageStatus["default"], {
      status: message.status,
      style: {
        marginRight: '-30px',
        marginTop: message.chatType === "singleChat" ? "0" : "22px"
      }
    }));
  };

  var createThread = function createThread() {
    onCreateThread(message);
  };

  var changeCopyVal = function changeCopyVal() {
    setCopyMsgVal(message.msg);
    handleClose();
  };

  var _customMessageClick = function _customMessageClick(val, option) {
    return function (e) {
      customMessageClick && customMessageClick(e, val, option);
      handleClose();
    };
  };

  return /*#__PURE__*/_react["default"].createElement("li", {
    className: classes.pulldownListItem,
    onMouseOver: function onMouseOver() {
      return setHoverDeviceModule(true);
    },
    onMouseLeave: function onMouseLeave() {
      return setHoverDeviceModule(false);
    }
  }, /*#__PURE__*/_react["default"].createElement("div", null, !message.bySelf && /*#__PURE__*/_react["default"].createElement("img", {
    className: classes.avatarStyle,
    src: (0, _utils.userAvatar)(message.from),
    onClick: function onClick(e) {
      return onAvatarChange && onAvatarChange(e, message);
    }
  }), showByselfAvatar && message.bySelf && /*#__PURE__*/_react["default"].createElement("img", {
    className: classes.avatarStyle,
    src: (0, _utils.userAvatar)(message.from)
  })), /*#__PURE__*/_react["default"].createElement("div", {
    className: classes.textBodyBox
  }, /*#__PURE__*/_react["default"].createElement("span", {
    className: classes.userName
  }, message.from), /*#__PURE__*/_react["default"].createElement("div", {
    className: classes.textBody,
    onContextMenu: handleClick,
    id: message.id
  }, renderTxt(message.body.msg), message.isThread, showThreaddInfo ? /*#__PURE__*/_react["default"].createElement(_msgThreadInfo["default"], {
    message: message
  }) : null, reactionMsg.length > 0 && /*#__PURE__*/_react["default"].createElement("div", {
    className: classes.reactionBox
  }, /*#__PURE__*/_react["default"].createElement(_renderReaction["default"], {
    message: message
  })), /*#__PURE__*/_react["default"].createElement("div", {
    className: classes.textReaction
  }, hoverDeviceModule ? /*#__PURE__*/_react["default"].createElement("div", {
    className: classes.textReactionCon
  }, isShowReaction && /*#__PURE__*/_react["default"].createElement(_reaction["default"], {
    message: message
  }), showThreadEntry && /*#__PURE__*/_react["default"].createElement("div", {
    className: classes.threadCon,
    onClick: createThread
  }, /*#__PURE__*/_react["default"].createElement(_core.Tooltip, {
    title: "Create Thread",
    placement: "top",
    classes: {
      tooltip: classes.tooltipthread
    }
  }, /*#__PURE__*/_react["default"].createElement("div", {
    className: classes.thread
  })))) : sentStatus()))), /*#__PURE__*/_react["default"].createElement("div", {
    className: classes.time
  }, (0, _utils.sessionItemTime)(message.time)), message.status === "read" ? /*#__PURE__*/_react["default"].createElement("div", {
    className: classes.read
  }, _i18next["default"].t("Read")) : null, /*#__PURE__*/_react["default"].createElement(_core.Menu, {
    keepMounted: true,
    open: menuState.mouseY !== null,
    onClose: handleClose,
    anchorReference: "anchorPosition",
    anchorPosition: menuState.mouseY !== null && menuState.mouseX !== null ? {
      top: menuState.mouseY,
      left: menuState.mouseX
    } : undefined
  }, message.bySelf && /*#__PURE__*/_react["default"].createElement(_core.MenuItem, {
    onClick: recallMessage
  }, _i18next["default"].t("Withdraw")), /*#__PURE__*/_react["default"].createElement(_core.MenuItem, {
    onClick: changeCopyVal
  }, /*#__PURE__*/_react["default"].createElement(_reactCopyToClipboard.CopyToClipboard, {
    text: copyMsgVal
  }, /*#__PURE__*/_react["default"].createElement("span", null, _i18next["default"].t("Copy")))), customMessageList && customMessageList.map(function (val, key) {
    var bySelf = message.bySelf;
    var show = false;

    if (val.position === 'others') {}

    switch (val.position) {
      case 'others':
        show = bySelf ? false : true;
        break;

      case 'self':
        show = bySelf ? true : false;
        break;

      default:
        show = true;
        break;
    }

    return show ? /*#__PURE__*/_react["default"].createElement(_core.MenuItem, {
      key: key,
      onClick: _customMessageClick(val, message)
    }, val.name) : null;
  })));
}

var _default = (0, _react.memo)(TextMessage);

exports["default"] = _default;
module.exports = exports.default;