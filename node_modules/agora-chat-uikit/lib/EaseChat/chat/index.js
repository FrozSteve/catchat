"use strict";

exports.__esModule = true;
exports["default"] = exports.EaseChatContext = void 0;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _react = _interopRequireWildcard(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _styles = require("@material-ui/styles");

var _messageList = _interopRequireDefault(require("./messageList"));

var _index = _interopRequireDefault(require("./messageBar/index"));

var _index2 = require("../../EaseApp/index");

var _reactRedux = require("react-redux");

var _sendBox = _interopRequireDefault(require("./sendBox"));

var _WebIM = _interopRequireWildcard(require("../../utils/WebIM"));

var _index3 = _interopRequireDefault(require("../../redux/index"));

var _WebIMListen = _interopRequireDefault(require("../../utils/WebIMListen"));

var _lodash = _interopRequireDefault(require("lodash"));

require("../../i18n");

require("../../common/iconfont.css");

var _nomessage = _interopRequireDefault(require("../../common/images/nomessage.jpg"));

var _avatar = _interopRequireDefault(require("../../common/images/avatar1.jpg"));

var _groupAvatar = _interopRequireDefault(require("../../common/images/groupAvatar.png"));

var _i18next = _interopRequireDefault(require("i18next"));

var _chatCallkit = _interopRequireDefault(require("chat-callkit"));

var _message = _interopRequireDefault(require("../../redux/message"));

var _threadPanel = _interopRequireDefault(require("../thread/threadPanel"));

var _alert = require("../common/alert");

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { "default": obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj["default"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

var EaseChatContext = (0, _react.createContext)();
exports.EaseChatContext = EaseChatContext;
var useStyles = (0, _styles.makeStyles)(function (theme) {
  return {
    root: {
      width: "100%",
      height: "calc(100% - 20px)",
      display: "flex",
      flexDirection: "column",
      alignItems: "center",
      justifyContent: "space-between",
      position: "relative"
    }
  };
});

var Chat = function Chat(props) {
  var agoraUid = props.agoraUid,
      appId = props.appId,
      getIdMap = props.getIdMap;

  var _useState = (0, _react.useState)({}),
      confrData = _useState[0],
      setConfr = _useState[1];

  (0, _react.useEffect)(function () {
    if (props.appkey && props.username && (props.agoraToken || props.password)) {
      (0, _WebIM.initIMSDK)(props.appkey);
      (0, _WebIMListen["default"])(props);

      if (_WebIM["default"].conn.logOut) {
        login();
      }
    }
  }, []);
  (0, _react.useEffect)(function () {
    var appId = '15cb0d28b87b425ea613fc46f7c9f974';
    console.log('初始化 callkit', agoraUid);

    _chatCallkit["default"].init(appId, agoraUid || '', _WebIM["default"].conn);
  }, [agoraUid]);

  var login = function login() {
    var noLogin = _WebIM["default"].conn.logOut;

    if (props.agoraToken) {
      noLogin && _WebIM["default"].conn.open({
        user: props.username,
        agoraToken: props.agoraToken,
        pwd: props.password,
        appKey: _WebIM["default"].config.appkey
      });
    } else if (props.password) {
      noLogin && _WebIM["default"].conn.open({
        user: props.username,
        pwd: props.password,
        appKey: _WebIM["default"].config.appkey
      });
    }
  };

  var classes = useStyles();
  var messageList = (0, _index2.useSelector)(function (state) {
    var to = state.global.globalProps.to;
    var chatType = state.global.globalProps.chatType;
    return _lodash["default"].get(state, ["message", chatType, to], []);
  }) || [];

  var _useState2 = (0, _react.useState)(false),
      showInviteModal = _useState2[0],
      setShowInvite = _useState2[1];

  var showInvite = function showInvite(confr) {
    console.log('点击添加人', confr);
    setConfr(confr);
    setShowInvite(!showInviteModal);
  };

  var closeInviteModal = function closeInviteModal() {
    setShowInvite(false);
  };

  var handleCallStateChange = /*#__PURE__*/function () {
    var _ref = _asyncToGenerator( /*#__PURE__*/_regenerator["default"].mark(function _callee(info) {
      var chatType, targetId, id, cusMessage, idMap;
      return _regenerator["default"].wrap(function _callee$(_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              console.log('info ----', info);
              _context.t0 = info.type;
              _context.next = _context.t0 === 'hangup' ? 4 : _context.t0 === 'refuse' ? 4 : _context.t0 === 'user-published' ? 13 : 21;
              break;

            case 4:
              setConfr({});
              chatType = 'singleChat';
              targetId = '';

              if (info.callInfo.groupId) {
                targetId = info.callInfo.groupId;
                chatType = 'groupChat';
              } else if (info.callInfo.callerIMName == _WebIM["default"].conn.context.userId) {
                targetId = info.callInfo.calleeIMName;
              } else {
                targetId = info.callInfo.callerIMName;
              }

              id = _WebIM["default"].conn.getUniqueId();
              cusMessage = {
                id: id,
                status: 'sent',
                body: {
                  type: 'custom',
                  info: info.callInfo
                },
                from: _WebIM["default"].conn.context.userId,
                to: targetId,
                chatType: chatType
              };

              _index3["default"].dispatch(_message["default"].addMessage(cusMessage));

              if (info.type == 'hangup') {
                if (info.reson == 'timeout') {
                  _alert.message.error('No response.');
                } else if (info.reson == 'refuse') {
                  _alert.message.error('Request declined.');
                } else if (info.reson == 'cancel') {
                  _alert.message.error('The call has been canceled.');
                } else if (info.reson == 'accepted on other devices') {
                  _alert.message.error('Other devices connected.');
                } else if (info.reson == 'refused on other devices') {
                  _alert.message.error('Other devices declined.');
                } else if (info.reson == 'busy') {
                  _alert.message.error('The line is busy.');
                } else {
                  _alert.message.error(info.reson || 'normal hangup');
                }
              }

              return _context.abrupt("break", 22);

            case 13:
              if (info.confr) {
                _context.next = 15;
                break;
              }

              return _context.abrupt("return");

            case 15:
              _context.next = 17;
              return getIdMap({
                userId: _WebIM["default"].conn.context.userId,
                channel: info.confr.channel
              });

            case 17:
              idMap = _context.sent;
              console.log('idMap', idMap);

              if (Object.keys(idMap).length > 0) {
                _chatCallkit["default"].setUserIdMap(idMap);
              }

              return _context.abrupt("break", 22);

            case 21:
              return _context.abrupt("break", 22);

            case 22:
            case "end":
              return _context.stop();
          }
        }
      }, _callee);
    }));

    return function handleCallStateChange(_x) {
      return _ref.apply(this, arguments);
    };
  }();

  var handleInvite = /*#__PURE__*/function () {
    var _ref2 = _asyncToGenerator( /*#__PURE__*/_regenerator["default"].mark(function _callee2(data) {
      var _yield$props$getRTCTo, agoraUid, accessToken;

      return _regenerator["default"].wrap(function _callee2$(_context2) {
        while (1) {
          switch (_context2.prev = _context2.next) {
            case 0:
              // props.onRTCInvite && props.onRTCInvite(data)
              console.log('收到邀请', data);
              _context2.next = 3;
              return props.getRTCToken({
                channel: data.channel,
                username: _WebIM["default"].conn.context.userId
              });

            case 3:
              _yield$props$getRTCTo = _context2.sent;
              agoraUid = _yield$props$getRTCTo.agoraUid;
              accessToken = _yield$props$getRTCTo.accessToken;

              _chatCallkit["default"].answerCall(true, accessToken);

            case 7:
            case "end":
              return _context2.stop();
          }
        }
      }, _callee2);
    }));

    return function handleInvite(_x2) {
      return _ref2.apply(this, arguments);
    };
  }();

  var to = (0, _index2.useSelector)(function (state) {
    return state.global.globalProps.to;
  });
  var showRTCCall = props.showRTCCall;
  return to ? /*#__PURE__*/_react["default"].createElement("div", {
    className: classes.root
  }, /*#__PURE__*/_react["default"].createElement(EaseChatContext.Provider, {
    value: props
  }, /*#__PURE__*/_react["default"].createElement(_index["default"], {
    showinvite: showInviteModal,
    onInviteClose: closeInviteModal,
    confrData: confrData
  }), /*#__PURE__*/_react["default"].createElement(_messageList["default"], {
    messageList: messageList,
    showByselfAvatar: props.showByselfAvatar
  }), /*#__PURE__*/_react["default"].createElement(_sendBox["default"], null), !showRTCCall ? /*#__PURE__*/_react["default"].createElement(_chatCallkit["default"], {
    onAddPerson: showInvite,
    onStateChange: handleCallStateChange,
    onInvite: handleInvite,
    contactAvatar: _avatar["default"],
    groupAvatar: _groupAvatar["default"],
    ringingSource: props.ringingSource
  }) : null)) : /*#__PURE__*/_react["default"].createElement("div", {
    style: {
      width: "100%",
      height: "100%",
      display: "flex",
      alignItems: "center",
      justifyContent: "center"
    }
  }, /*#__PURE__*/_react["default"].createElement("img", {
    src: _nomessage["default"],
    alt: "",
    style: {
      height: "200px",
      width: "200px"
    }
  }), /*#__PURE__*/_react["default"].createElement(_react["default"].Fragment, null, /*#__PURE__*/_react["default"].createElement(_chatCallkit["default"], {
    onAddPerson: showInvite,
    onStateChange: handleCallStateChange,
    onInvite: handleInvite,
    contactAvatar: _avatar["default"],
    groupAvatar: _groupAvatar["default"],
    ringingSource: props.ringingSource
  }), /*#__PURE__*/_react["default"].createElement(EaseChatContext.Provider, {
    value: props
  }, /*#__PURE__*/_react["default"].createElement("div", {
    style: {
      display: 'none'
    }
  }, /*#__PURE__*/_react["default"].createElement(_index["default"], {
    showinvite: showInviteModal,
    onInviteClose: closeInviteModal,
    confrData: confrData
  })))));
};

var Thread = function Thread(props) {
  return /*#__PURE__*/_react["default"].createElement(EaseChatContext.Provider, {
    value: props
  }, /*#__PURE__*/_react["default"].createElement(_threadPanel["default"], null));
};

var EaseChatProvider = function EaseChatProvider(props) {
  var threadPanelStates = (0, _index2.useSelector)(function (state) {
    var _state$thread;

    return (_state$thread = state.thread) === null || _state$thread === void 0 ? void 0 : _state$thread.threadPanelStates;
  });
  return /*#__PURE__*/_react["default"].createElement(_reactRedux.Provider, {
    store: _index3["default"]
  }, /*#__PURE__*/_react["default"].createElement(_react["default"].StrictMode, null, /*#__PURE__*/_react["default"].createElement("div", {
    style: {
      display: 'flex',
      height: '100%'
    }
  }, /*#__PURE__*/_react["default"].createElement("div", {
    style: {
      flex: '1 1 auto',
      height: '100%'
    }
  }, /*#__PURE__*/_react["default"].createElement(Chat, props)), /*#__PURE__*/_react["default"].createElement("div", {
    style: {
      flex: '0 0 392px',
      overflow: 'hidden',
      display: threadPanelStates ? 'flex' : 'none',
      height: '100%'
    }
  }, /*#__PURE__*/_react["default"].createElement("hr", {
    style: {
      width: 0,
      height: '100%',
      border: 'none',
      borderRight: '8px solid #edeff2',
      marginTop: '0px'
    }
  }), /*#__PURE__*/_react["default"].createElement(Thread, props)))));
};

EaseChatProvider.getSdk = function (props) {
  if (!_WebIM["default"].conn) {
    (0, _WebIM.initIMSDK)(props.appkey);
    (0, _WebIMListen["default"])(props);
  }

  return _WebIM["default"];
};

var _default = EaseChatProvider;
exports["default"] = _default;
EaseChatProvider.propTypes = process.env.NODE_ENV !== "production" ? {
  appkey: _propTypes["default"].string,
  username: _propTypes["default"].string,
  agoraToken: _propTypes["default"].string,
  password: _propTypes["default"].string,
  chatType: _propTypes["default"].string,
  to: _propTypes["default"].string,
  showByselfAvatar: _propTypes["default"].bool,
  easeInputMenu: _propTypes["default"].string,
  menuList: _propTypes["default"].array,
  handleMenuItem: _propTypes["default"].func,
  successLoginCallback: _propTypes["default"].func,
  failCallback: _propTypes["default"].func,
  onChatAvatarClick: _propTypes["default"].func,
  isShowReaction: _propTypes["default"].bool,
  customMessageList: _propTypes["default"].array,
  customMessageClick: _propTypes["default"].func,
  onOpenThreadPanel: _propTypes["default"].func,
  agoraUid: _propTypes["default"].string,
  isShowRTC: _propTypes["default"].bool,
  getRTCToken: _propTypes["default"].func,
  getIdMap: _propTypes["default"].func,
  appId: _propTypes["default"].string,
  deleteSessionAndMessage: _propTypes["default"].func
} : {};
EaseChatProvider.defaultProps = {
  showByselfAvatar: false,
  easeInputMenu: 'all',
  isChatThread: false,
  isShowRTC: true,
  menuList: [{
    name: _i18next["default"].t('send-image'),
    value: "img",
    key: "1"
  }, {
    name: _i18next["default"].t('send-file'),
    value: "file",
    key: "2"
  }, {
    name: _i18next["default"].t('send-video'),
    value: "video",
    key: "3"
  }]
};